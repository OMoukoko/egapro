---
dist: xenial
language: minimal
git:
  depth: 5

#

.env:
  github_keys: &github_keys
    - secure: "DNLGmdTILROhurZmHfIP29yMETW7+wk0GvnrsvywkkLFWUsMny8YqWkuNTZfz8nzyzE5Qpw75800rJ7VEmgJQDNhKcuk/y04bPiEiZg+EzoZu+XXgeZJXsWkb3PIryHlN/h8p9YWFum8Xfr4beY/mhIrzsxJfkdFodmR9KpbuL0jUZ+414DeTXZIZzdda6jzfs1a5XCkZPoQ/5FZZEla4GTxpV5vrem3EqutKGYpi+7OG4QKBqW1GkZTTHAkGR9YAu0BO2nikPUBdL0KbBo+jWyUTljtDoApc5s/TFqFcSSOBwzzHRNDLjt7GPH+c73LBCpwN8mqzF1iXuhoDcJNVe8+MhInU1HXzLLYCdJ3e2H7J5QNF9Qs82fHxMBxXIecD2hzGJATwQmMpuKXgxtRYCWuKHROanL3aga+qU8m7JIQkIpYVm8tJ19HZimWrbp1Ms7z1RZXr2uruH7RP0xCvYgglAkiq5FMfDxdpzqkZ65UOV9gxu/TDyVIpRWVdgWcLi8suti4LYebdspigA+fWTHUNufhyCGNlUQkTkk5XXGVAmvwrFl9HkW5IsNZM2iJ4Q7CtZ7gZ/qRglG+Ct4KXOFHcqvyetBSraVxpL2BNlPIx+lTcpPA49h2x44IyFsOTSSHBPlrIzTVAhFKHaGwGxw9mYbYmZxwagWEtHkum5U="

#

.node_stage: &node_stage
  language: node_js
  node_js: "10"
  cache: yarn
  before_install:
    - curl -o- -L https://yarnpkg.com/install.sh | bash
    - export PATH="$HOME/.yarn/bin:$PATH"
  install:
    - yarn --frozen-lockfile

#

jobs:
  include:
    - stage: Build
      <<: *node_stage
      script:
        - yarn build
        - yarn lint
        - yarn coverage
      after_script:
        - npx codecov

    #
    #
    #

    - stage: Release
      name: Make a new release ðŸŽ‰
      if: env(RELEASE)
      <<: *node_stage
      git:
        # NOTE(douglasduteil): disable git --depth
        # Try to have all the commits for the release Change Log
        # see travis-ci/travis-ci#3412
        depth: 9999999 # Over 9000 !
      env: *github_keys
      before_script:
        - git checkout ${TRAVIS_BRANCH}
        - git config user.name "Social Groovy Bot"
        - git config user.email "45039513+SocialGroovyBot@users.noreply.github.com"
        - git remote set-url origin https://${GITHUB_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git
      script:
        - GH_TOKEN=${GITHUB_TOKEN} yarn lerna version ${LERNA_ARGS:=--yes}
